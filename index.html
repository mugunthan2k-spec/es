<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eco Sudar ‚Äì Smart Attendance</title>

  <!-- QR decode library -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <style>
    :root{
      --eco-red:#e53935;
      --eco-red2:#c62828;
      --eco-green:#1aa15f;
      --eco-dark:#0f172a;
      --eco-muted:#64748b;
      --line:#e5e7eb;
      --card:#ffffff;
      --shadow: 0 16px 50px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--eco-dark);
      background:
        radial-gradient(900px 600px at 10% -10%, rgba(229,57,53,.16), transparent 60%),
        radial-gradient(900px 600px at 95% 0%, rgba(26,161,95,.14), transparent 55%),
        #fff;
      padding:14px;
      display:flex;
      justify-content:center;
    }
    .app{width:100%;max-width:980px}
    .top{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:260px}
    .logo{
      width:58px;height:58px;border-radius:14px;
      background:#fff;border:1px solid var(--line);
      padding:6px; object-fit:contain;
    }
    h1{margin:0;font-size:18px;line-height:1.2}
    .sub{margin:4px 0 0 0;color:var(--eco-muted);font-size:13px}
    .tabs{display:flex;gap:10px}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--eco-dark);
      border-radius:14px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;gap:8px;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.red{border:0;color:#fff;background:linear-gradient(90deg,var(--eco-red),var(--eco-red2))}
    .btn.green{border:0;color:#fff;background:linear-gradient(90deg,var(--eco-green),#0f8a4e)}
    .btn.gray{background:#f3f4f6}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);background:#fff;
      font-weight:900;font-size:12.5px;
    }
    .right{margin-left:auto}
    .status{
      margin-top:10px;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:#fff;
    }
    .status.ok{border-color:rgba(26,161,95,.35);background:rgba(26,161,95,.08)}
    .status.bad{border-color:rgba(229,57,53,.35);background:rgba(229,57,53,.08)}
    .status .big{font-weight:1000}
    .status .msg{margin-top:3px;color:var(--eco-muted);font-size:13px;word-break:break-word}
    video{
      width:100%;
      max-height:460px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#000;
      object-fit:cover;
    }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:13px;text-align:left;vertical-align:top}
    th{color:var(--eco-muted);font-weight:1000;font-size:12.5px}
    .thumb{
      width:58px;height:58px;border-radius:12px;object-fit:cover;
      border:1px solid var(--line);background:#fff;
    }
    .mono{font-variant-numeric:tabular-nums}
    .hidden{display:none !important}
    .inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    input,select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      font-weight:900;
      outline:none;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      display:none;
      max-width:min(92vw,680px);
      z-index:9999;
    }
    .toast.show{display:block}
    .jsok{
      position:fixed;top:10px;right:10px;
      background:#16a34a;color:#fff;
      padding:8px 10px;border-radius:10px;
      font-weight:900;z-index:99999
    }
  </style>
</head>

<body>
  <div class="jsok">JS OK</div>

  <div class="app">
    <div class="top">
      <div class="brand">
        <img src="logo.png" class="logo" alt="Eco Sudar logo">
        <div>
          <h1>Eco Sudar ‚Äì Smart Attendance</h1>
          <div class="sub">One link ‚Ä¢ Mobile kiosk scanning ‚Ä¢ Admin monthly reports</div>
        </div>
      </div>

      <div class="tabs">
        <button class="btn green" id="tabScan">üì∑ Scan</button>
        <button class="btn red" id="tabAdmin">üìä Admin</button>
      </div>
    </div>

    <div id="scanView" class="grid">
      <div class="card">
        <div class="row">
          <span class="pill">Selfie camera</span>
          <span class="pill right mono" id="camState">Camera: OFF</span>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn green" id="btnStart">‚ñ∂ Start Kiosk</button>
          <button class="btn red" id="btnStop">‚èπ Stop Kiosk</button>
          <button class="btn gray" id="btnClearToday">üßπ Clear Today Table</button>
        </div>

        <div style="margin-top:12px">
          <video id="video" playsinline muted></video>
          <canvas id="canvas" class="hidden"></canvas>
        </div>

        <div id="scanStatus" class="status ok">
          <div class="big" id="scanTitle">Ready</div>
          <div class="msg" id="scanMsg">Tap ‚ÄúStart Kiosk‚Äù.</div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <span class="pill">Today ‚Äì Live View</span>
          <span class="pill right mono" id="todayDate"></span>
        </div>

        <table>
          <thead>
            <tr>
              <th class="mono">Time</th>
              <th>Employee</th>
              <th>Action</th>
              <th>Photo</th>
            </tr>
          </thead>
          <tbody id="todayBody"></tbody>
        </table>
      </div>
    </div>

    <div id="adminView" class="hidden">
      <div class="card" style="margin-top:14px">
        <div class="row">
          <span class="pill">Admin Monthly Report</span>
          <span class="pill right">PIN: <span class="mono">7274</span></span>
        </div>

        <div class="inputs">
          <input id="pin" type="password" inputmode="numeric" placeholder="Enter PIN (7274)">
          <div></div>
          <select id="year"></select>
          <select id="month"></select>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn red" id="btnLoad">Load Monthly Report</button>
          <button class="btn gray" id="btnExport">Export CSV</button>
        </div>

        <div id="repStatus" class="status ok">
          <div class="big" id="repTitle">Report</div>
          <div class="msg" id="repMsg">Select month/year and tap ‚ÄúLoad Monthly Report‚Äù.</div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Employee</th>
              <th class="mono">Action</th>
              <th class="mono">IN</th>
              <th class="mono">OUT</th>
              <th class="mono">Hrs</th>
              <th>Photo</th>
            </tr>
          </thead>
          <tbody id="repBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ‚úÖ Your Apps Script URL
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby7BB803v2AsaaWC3auzSpWZ3F2Ten8LrGcLAYGlwFrUdykaIRC2aY8zd9QWwNFFVuVJw/exec";
    const ADMIN_PIN = "7274";

    document.addEventListener("DOMContentLoaded", () => {
      const $ = (id)=>document.getElementById(id);

      const scanView = $("scanView");
      const adminView = $("adminView");
      $("tabScan").onclick = ()=>{ scanView.classList.remove("hidden"); adminView.classList.add("hidden"); };
      $("tabAdmin").onclick = ()=>{ scanView.classList.add("hidden"); adminView.classList.remove("hidden"); };

      const video = $("video");
      const canvas = $("canvas");
      const todayBody = $("todayBody");

      const todayISO = ()=>new Date().toISOString().slice(0,10);
      $("todayDate").textContent = "Date: " + todayISO();

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(()=>t.classList.remove("show"), 1600);
      }
      function setScanStatus(ok, title, msg){
        $("scanStatus").className = "status " + (ok ? "ok" : "bad");
        $("scanTitle").textContent = title;
        $("scanMsg").textContent = msg;
      }
      function setRepStatus(ok, title, msg){
        $("repStatus").className = "status " + (ok ? "ok" : "bad");
        $("repTitle").textContent = title;
        $("repMsg").textContent = msg;
      }
      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }
      function beep(times=1){
        try{
          const Ctx = window.AudioContext || window.webkitAudioContext;
          const ctx = new Ctx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine"; o.frequency.value = 880;
          o.connect(g); g.connect(ctx.destination);
          let t = ctx.currentTime;
          for(let i=0;i<times;i++){
            g.gain.setValueAtTime(0.0001, t);
            g.gain.exponentialRampToValueAtTime(0.22, t+0.01);
            g.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
            t += 0.18;
          }
          o.start(); o.stop(t);
          o.onended = ()=>ctx.close();
        }catch(e){}
      }

      // State for AUTO IN/OUT
      const LS_OPEN = "ecosudar_open_v3";
      const LS_COOL = "ecosudar_cool_v3";
      function loadJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){ return fallback; } }
      function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
      function decideAction(name){
        const open = loadJSON(LS_OPEN, {});
        return open[${name}|${todayISO()}] ? "OUT" : "IN";
      }
      function markOpen(name, isOpen){
        const open = loadJSON(LS_OPEN, {});
        const key = ${name}|${todayISO()};
        if(isOpen) open[key]=true; else delete open[key];
        saveJSON(LS_OPEN, open);
      }
      function allowedToScan(name){
        const cool = loadJSON(LS_COOL, {});
        const now = Date.now();
        const last = cool[name] || 0;
        if(now - last < 2500) return false;
        cool[name] = now;
        saveJSON(LS_COOL, cool);
        return true;
      }

      // Camera + scan
      let stream = null;
      let scanning = false;
      let locked = false;

      function captureSelfieDataURL(){
        const w = video.videoWidth || 640;
        const h = video.videoHeight || 480;
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);
        return canvas.toDataURL("image/jpeg", 0.78);
      }

      async function postLog(name, action, photoBase64){
        const payload = { name, type: action, ts: new Date().toISOString(), photoBase64 };
        const res = await fetch(${WEB_APP_URL}?action=log, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        return await res.json();
      }

      function addTodayRow(name, action, photoUrl){
        const t = new Date();
        const timeStr = t.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit",second:"2-digit"});
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(timeStr)}</td>
          <td><b>${escapeHtml(name)}</b></td>
          <td class="mono">${escapeHtml(action)}</td>
          <td>${photoUrl ? <a href="${photoUrl}" target="_blank" rel="noopener"><img class="thumb" src="${photoUrl}"></a> : "-"}</td>
        `;
        todayBody.prepend(tr);
      }

      async function startKiosk(){
        if(scanning) return;
        try{
          // user gesture for audio permission
          beep(1);

          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode:"user", width:{ideal:1280}, height:{ideal:720} },
            audio:false
          });
          video.srcObject = stream;
          await video.play();

          scanning = true;
          locked = false;
          $("camState").textContent = "Camera: ON";
          setScanStatus(true, "Scanning‚Ä¶", "Show QR (name). Beep ‚Üí selfie ‚Üí upload ‚Üí double-beep.");
          requestAnimationFrame(scanLoop);
        }catch(err){
          $("camState").textContent = "Camera: OFF";
          setScanStatus(false, "Camera blocked", "Allow camera permission and reload.");
          toast("Camera blocked");
        }
      }

      function stopKiosk(){
        scanning = false;
        locked = false;
        try{
          if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
        }catch(e){}
        video.srcObject = null;
        $("camState").textContent = "Camera: OFF";
        setScanStatus(true, "Stopped", "Tap Start Kiosk again.");
      }

      $("btnStart").onclick = startKiosk;
      $("btnStop").onclick = stopKiosk;
      $("btnClearToday").onclick = ()=>{ todayBody.innerHTML=""; toast("Today view cleared"); };

      async function scanLoop(){
        if(!scanning) return;

        try{
          const w = video.videoWidth || 0;
          const h = video.videoHeight || 0;
          if(w > 0 && h > 0){
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, w, h);
            const img = ctx.getImageData(0,0,w,h);

            if(!window.jsQR){
              setScanStatus(false, "Library missing", "jsQR not loaded. Check internet.");
            }else{
              const code = jsQR(img.data, w, h, { inversionAttempts:"dontInvert" });
              if(code && code.data && !locked){
                const name = String(code.data).trim();
                if(name && allowedToScan(name)){
                  locked = true;
                  beep(1);
                  setScanStatus(true, "Scanned", ${name} detected. Capturing selfie & uploading‚Ä¶);

                  const action = decideAction(name);
                  const selfie = captureSelfieDataURL();

                  let resp;
                  try{ resp = await postLog(name, action, selfie); }
                  catch(e){ resp = { ok:false, error:"Network error" }; }

                  if(resp && resp.ok){
                    if(action === "IN") markOpen(name, true); else markOpen(name, false);
                    beep(2);
                    addTodayRow(name, action, resp.photoUrl || "");
                    setScanStatus(true, action === "OUT" ? "Thank you" : "Success",
                      ${name} marked ${action}.);
                    toast(${name} ${action} ‚úÖ);
                  }else{
                    setScanStatus(false, "Upload failed", (resp && resp.error) ? resp.error : "Unknown error");
                    toast("Upload failed");
                  }

                  setTimeout(()=>{ locked=false; }, 650);
                }
              }
            }
          }
        }catch(e){}

        requestAnimationFrame(scanLoop);
      }

      // ADMIN REPORT
      const yearSel = $("year");
      const monthSel = $("month");
      const repBody = $("repBody");
      let currentRows = [];

      function fillYM(){
        const now = new Date();
        const y = now.getFullYear();
        for(let i=y-2;i<=y+1;i++){
          const o=document.createElement("option");
          o.value=String(i); o.textContent=String(i);
          if(i===y) o.selected=true;
          yearSel.appendChild(o);
        }
        const names=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        const m=now.getMonth()+1;
        for(let i=1;i<=12;i++){
          const o=document.createElement("option");
          o.value=String(i);
          o.textContent=String(i).padStart(2,"0")+" - "+names[i-1];
          if(i===m) o.selected=true;
          monthSel.appendChild(o);
        }
      }
      fillYM();

      async function fetchMonthly(year, month){
        const res = await fetch(${WEB_APP_URL}?action=report&year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)});
        return await res.json();
      }
      function renderReport(rows){
        repBody.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${escapeHtml(r.date||"")}</td>
            <td><b>${escapeHtml(r.employee||"")}</b></td>
            <td class="mono">${escapeHtml(r.action||"")}</td>
            <td class="mono">${escapeHtml(r.inTime||"")}</td>
            <td class="mono">${escapeHtml(r.outTime||"")}</td>
            <td class="mono">${escapeHtml(r.hrs||"")}</td>
            <td>${r.photoUrl ? <a href="${r.photoUrl}" target="_blank" rel="noopener"><img class="thumb" src="${r.photoUrl}"></a> : "-"}</td>
          `;
          repBody.appendChild(tr);
        }
      }

      $("btnLoad").onclick = async ()=>{
        if(($("pin").value || "").trim() !== ADMIN_PIN){
          setRepStatus(false, "Denied", "Wrong PIN.");
          return;
        }
        const year = Number(yearSel.value);
        const month = Number(monthSel.value);

        setRepStatus(true, "Loading‚Ä¶", "Fetching report‚Ä¶");
        repBody.innerHTML = "";
        currentRows = [];

        try{
          const data = await fetchMonthly(year, month);
          if(!data || !data.ok){
            setRepStatus(false, "Failed", (data && data.error) ? data.error : "Could not load report");
            return;
          }
          currentRows = data.rows || [];
          renderReport(currentRows);
          setRepStatus(true, currentRows.length ? "Loaded" : "No data", Rows: ${currentRows.length});
        }catch(e){
          setRepStatus(false, "Failed", "Network error");
        }
      };

      $("btnExport").onclick = ()=>{
        if(!currentRows.length){ toast("No rows to export"); return; }
        const header = ["Date","Employee","Action","InTime","OutTime","Hrs","PhotoURL"];
        const lines = [header];
        for(const r of currentRows){
          lines.push([r.date||"", r.employee||"", r.action||"", r.inTime||"", r.outTime||"", r.hrs||"", r.photoUrl||""]);
        }
        const csv = lines.map(row => row.map(v => "${String(v).replace(/"/g,'""')}").join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "EcoSudar_MonthlyReport.csv";
        a.click();
        URL.revokeObjectURL(url);
      };

      setScanStatus(true, "Ready", "Tap ‚ÄúStart Kiosk‚Äù.");
      setRepStatus(true, "Report", "Select month/year and tap ‚ÄúLoad Monthly Report‚Äù.");
      toast("Loaded ‚úÖ");
    });
  </script>
</body>
</html>
